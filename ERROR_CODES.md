# 错误码速查表（商城版）

> **核心原则**：
> 1. **成功码固定为 20000**，所有成功场景统一返回此码
> 2. **message 通过 i18n 语言包国际化**（如 "用户创建成功"、"订单创建成功"）
> 3. **错误码从 60100 开始连续累加**，按百位分段（每个子模块占用 100 个码位）
> 4. **新增模块顺延分配**，无需预先规划模块归属，灵活扩展
> 5. **5 位数固定长度**，前 3 位代表子模块，后 2 位代表具体错误

---

## 📖 错误码分段规划（连续累加）

| 错误码范围 | 业务模块 | 说明 |
|-----------|---------|------|
| **20000** | Success | 🎯 **全局唯一成功码**，message 通过语言包处理 |
| **50000-50999** | 系统级错误 | 数据库/Redis/第三方服务异常（预留1000个） |
| **60100-60199** | 用户注册 | 手机号/邮箱/用户名唯一性、密码强度、验证码 |
| **60200-60299** | 用户登录 | 密码校验、Token、账号锁定、二次认证 |
| **60300-60399** | 用户资料 | 用户信息查询、修改、实名认证 |
| **60400-60499** | 用户权限 | 权限校验、角色管理、会员等级 |
| **60500-60599** | 商品查询 | 商品/SKU/分类查询、下架状态 |
| **60600-60699** | 商品管理 | 商品创建、编辑、审核（商家端） |
| **60700-60799** | 库存管理 | 库存查询、扣减、锁定、释放 |
| **60800-60899** | 购物车 | 购物车增删改查、限购、数量限制 |
| **60900-60999** | 订单创建 | 下单校验、地址、优惠券、价格计算 |
| **61000-61099** | 订单支付 | 支付校验、超时、金额匹配、渠道 |
| **61100-61199** | 订单履约 | 发货、取消、完成、状态流转 |
| **61200-61299** | 退款售后 | 退款申请、审核、期限、资格 |
| **61300-61399** | 优惠券 | 领取、使用、过期、库存 |
| **61400-61499** | 营销活动 | 秒杀、团购、活动时间、库存 |
| **61500-61599** | 积分会员 | 积分余额、兑换、会员等级 |
| **61600-61699** | 收货地址 | 地址增删改查、默认地址、数量限制 |
| **61700-61799** | 物流配送 | 物流查询、配送范围、快递单号 |
| **61800-61899** | 评价评论 | 评价权限、重复评价、违规检测 |
| **61900-61999** | 客服工单 | 客服在线、工单状态、重复提交 |
| **62000-62099** | 消息通知 | 站内信、推送、已读状态 |
| **62100+** | 扩展预留 | 新增模块继续往上累加 |

> **分配策略**：
> - ✅ 从 60100 开始，每 100 个码位分配给一个子模块
> - ✅ 新增模块直接顺延（如 62100-62199 分配给"直播带货"）
> - ✅ 系统错误独立使用 50000-50999 段（与业务错误隔离）
> - ✅ 理论上限：99999，可支持 **390+ 个子模块**

---

## ✅ 1. 成功码（全局唯一）

| Code  | 说明 | 示例 message（通过 i18n 处理） |
|-------|------|------------------------------|
| 20000 | 所有成功场景统一返回此码 | "用户创建成功" / "订单支付成功" / "商品上架成功" |

**前端判断逻辑**：
```typescript
if (response.code === 20000) {
  // 成功：显示 response.message（已国际化）
  Toast.success(response.message);
} else {
  // 失败：根据 code 做精细化处理
  handleError(response.code, response.message);
}
```

---

## 🔧 2. 系统级错误 (50000-50999)

> **说明**：系统错误独立分段，与业务错误隔离

### 50000-50099: 内部错误
| Code  | Message | 说明 | HTTP Status |
|-------|---------|------|-------------|
| 50000 | 系统内部错误 | 未捕获异常 | 500 |
| 50001 | 数据库连接失败 | PostgreSQL 不可用 | 503 |
| 50002 | Redis 连接失败 | 缓存服务异常 | 503 |
| 50003 | 配置错误 | 环境变量缺失或非法 | 500 |

### 50100-50199: 第三方服务错误
| Code  | Message | 说明 |
|-------|---------|------|
| 50101 | 短信服务异常 | 阿里云短信 API 失败 |
| 50102 | 支付网关异常 | 微信/支付宝接口超时 |
| 50103 | 物流接口异常 | 快递 100 API 失败 |
| 50104 | OSS 上传失败 | 文件存储服务异常 |
| 50105 | AI 服务异常 | 如 OCR/NLP 接口失败 |

---

## 👤 3. 用户模块 (60100-60499)

### 20100-20199: 用户注册
| Code  | Message | 说明 | 解决方案 |
|-------|---------|------|----------|
| 20101 | 手机号已被注册 | 手机号唯一性冲突 | 提示用户更换手机号或找回密码 |
| 20102 | 邮箱已被注册 | 邮箱唯一性冲突 | 提示用户更换邮箱 |
| 20103 | 用户名已被占用 | 用户名唯一性冲突 | 提示用户更换用户名 |
| 20104 | 密码强度不足 | 不符合安全策略 | 提示密码规则 |
| 20105 | 验证码错误或已过期 | 短信/邮箱验证码校验失败 | 重新发送验证码 |

### 20200-20299: 用户登录与认证
| Code  | Message | 说明 | HTTP Status |
|-------|---------|------|-------------|
| 20201 | 账号或密码错误 | 登录失败（模糊报错防枚举） | 401 |
| 20202 | 账号已被锁定 | 连续登录失败触发锁定 | 403 |
| 20203 | Refresh Token 无效 | Token 已失效或不存在 | 401 |
| 20204 | 需要二次认证 | 如需短信验证码 | 401 |

### 20300-20399: 用户资料管理
| Code  | Message | 说明 |
|-------|---------|------|
| 20301 | 用户不存在 | 查询/操作的用户 ID 无效 |
| 20302 | 无权修改他人资料 | IDOR 防护 |
| 20303 | 实名认证未通过 | 身份证/人脸识别失败 |

### 20400-20499: 权限与角色（业务级）
| Code  | Message | 说明 |
|-------|---------|------|
| 20401 | 非 VIP 用户 | 需要会员权限 |
| 20402 | 非管理员 | 需要管理员角色 |

## 🛍️ 4. 商品与库存模块 (60500-60799)

## 🛍️ 4. 商品与库存域 (30000-39999)

### 30100-30199: 商品查询与展示
| Code  | Message | 说明 |
|-------|---------|------|
| 30101 | 商品不存在 | SPU/SKU ID 无效 |
| 30102 | 商品已下架 | is_active=False |
| 30103 | 商品分类不存在 | 分类 ID 无效 |

### 30200-30299: 商品管理（商家端）
| Code  | Message | 说明 |
|-------|---------|------|
| 30201 | 商品名称重复 | 同商家下商品名冲突 |
| 30202 | SKU 编码重复 | SKU Code 唯一性冲突 |
| 30203 | 商品审核未通过 | 平台审核拒绝 |

### 30300-30399: 库存管理
| Code  | Message | 说明 | 解决方案 |
|-------|---------|------|----------|
| 30301 | 库存不足 | 可用库存 < 购买数量 | 提示用户减少数量或补货通知 |
| 30302 | 库存锁定失败 | 并发下单导致超卖 | 稍后重试 |
| 30303 | SKU 已售罄 | 当前规格无货 | 推荐其他规格 |

## 📦 5. 订单与交易模块 (60800-61299)

## 📦 5. 订单与交易域 (40000-49999)

### 40100-40199: 购物车
| Code  | Message | 说明 |
|-------|---------|------|
| 40101 | 购物车商品不存在 | 商品已删除或下架 |
| 40102 | 购物车已达上限 | 单个购物车商品数限制 |
| 40103 | 商品数量超出限购 | 超出单次购买限制 |

### 40200-40299: 订单创建
| Code  | Message | 说明 |
|-------|---------|------|
| 40201 | 订单金额计算错误 | 价格篡改检测 |
| 40202 | 收货地址无效 | 地址 ID 不存在或不属于当前用户 |
| 40203 | 配送范围不支持 | 商品不配送到指定地区 |
| 40204 | 优惠券不可用 | 券已过期/已使用/条件不满足 |

### 40300-40399: 订单支付
| Code  | Message | 说明 |
|-------|---------|------|
| 40301 | 订单已支付 | 重复支付拦截 |
| 40302 | 订单已超时 | 超过支付时限自动取消 |
| 40303 | 支付金额不匹配 | 订单金额与支付金额不一致 |

### 40400-40499: 订单履约
| Code  | Message | 说明 |
|-------|---------|------|
| 40401 | 订单状态不允许发货 | 如未支付/已取消 |
| 40402 | 订单状态不允许取消 | 如已发货 |
| 40403 | 订单不存在 | 订单 ID 无效 |

### 40500-40599: 退款与售后
| Code  | Message | 说明 |
|-------|---------|------|
| 40501 | 超出退款期限 | 如 7 天无理由退货期 |
| 40502 | 不支持退款的商品 | 如虚拟商品 |
| 40503 | 退款申请审核中 | 重复提交拦截 |

---

## 🔧 6. 系统级错误 (50000-59999)

### 50000-50099: 内部错误
| Code  | Message | 说明 | HTTP Status |
|-------|---------|------|-------------|
| 50000 | 系统内部错误 | 未捕获异常 | 500 |
| 50001 | 数据库连接失败 | DB 不可用 | 503 |
| 50002 | Redis 连接失败 | 缓存服务异常 | 503 |

### 50100-50199: 第三方服务错误
| Code  | Message | 说明 |
|-------|---------|------|
| 50101 | 短信服务异常 | 阿里云短信 API 失败 |
| 50102 | 支付网关异常 | 微信/支付宝接口超时 |
| 50103 | 物流接口异常 | 快递 100 API 失败 |
| 50104 | OSS 上传失败 | 文件存储服务异常 |

---

## 🎁 7. 营销与优惠域 (60000-69999)

### 60100-60199: 优惠券
| Code  | Message | 说明 |
|-------|---------|------|
| 60101 | 优惠券已领完 | 库存为 0 |
| 60102 | 优惠券已过期 | 超出有效期 |
| 60103 | 不满足使用条件 | 如订单金额不足 |
| 60104 | 优惠券已被使用 | 重复核销拦截 |

### 60200-60299: 活动与促销
| Code  | Message | 说明 |
|-------|---------|------|
| 60201 | 活动未开始 | 秒杀/团购未到时间 |
| 60202 | 活动已结束 | 超出活动时间 |
| 60203 | 活动商品已抢光 | 秒杀库存耗尽 |

### 60300-60399: 积分与会员
| Code  | Message | 说明 |
|-------|---------|------|
| 60301 | 积分余额不足 | 积分兑换失败 |
| 60302 | 会员等级不足 | 需更高等级会员 |

---

## 🚚 8. 物流与配送域 (70000-79999)

### 70100-70199: 收货地址
| Code  | Message | 说明 |
|-------|---------|------|
| 70101 | 地址数量已达上限 | 单用户地址限制 |
| 70102 | 默认地址不存在 | 下单时未选择地址 |
| 70103 | 地址格式错误 | 省市区不匹配 |

### 70200-70299: 物流跟踪
| Code  | Message | 说明 |
|-------|---------|------|
| 70201 | 物流信息未找到 | 快递单号无效 |
| 70202 | 配送范围不支持 | 不配送偏远地区 |

---

## 💳 9. 支付与财务域 (80000-89999)

### 80100-80199: 支付通道
| Code  | Message | 说明 |
|-------|---------|------|
| 80101 | 支付渠道维护中 | 如微信支付暂停 |
| 80102 | 支付金额超出限额 | 单笔/日累计限额 |
| 80103 | 银行卡余额不足 | 第三方返回 |

### 80200-80299: 账户余额
| Code  | Message | 说明 |
|-------|---------|------|
| 80201 | 账户余额不足 | 钱包余额 < 支付金额 |
| 80202 | 提现金额不足 | 未达最低提现额 |
| 80203 | 提现账户未绑定 | 未实名认证 |

---

## 🔮 10. 扩展预留 (90000-99999)

### 90100-90199: 评价与评论
| Code  | Message | 说明 |
|-------|---------|------|
| 90101 | 订单未完成无法评价 | 需订单状态=已完成 |
| 90102 | 评价已存在 | 重复评价拦截 |
| 90103 | 评价内容违规 | 敏感词过滤 |

### 90200-90299: 客服与工单
| Code  | Message | 说明 |
|-------|---------|------|
| 90201 | 客服不在线 | 非工作时间 |
| 90202 | 工单处理中 | 重复提交拦截 |

### 90300-90399: 消息与通知
| Code  | Message | 说明 |
|-------|---------|------|
| 90301 | 消息发送失败 | 站内信/推送失败 |
| 90302 | 消息已读 | 重复已读拦截 |

---

## 📝 使用规范与最佳实践

### 1. 成功响应处理

**后端代码**：
```python
from app.core.response import success

# ✅ 所有成功场景都返回 20000
return success(
    data=user,
    message="用户创建成功"  # 可通过 i18n 翻译
)

# ✅ 不同场景，message 不同，但 code 统一为 20000
return success(data=order, message="订单创建成功")
return success(data=None, message="密码修改成功")
```

**前端处理**：
```typescript
// ✅ 统一判断成功
if (response.code === 20000) {
  Toast.success(response.message);  // 显示后端返回的 message
  return response.data;
}
```

### 2. 错误码命名原则
- **模块内连续**: 同一模块的错误码尽量连续分配
- **语义清晰**: 通过 code 可大致判断所属模块
- **预留空间**: 每个百位段预留 20-30 个码位用于扩展

### 3. 代码中定义位置

**方式 A：集中定义常量类**（推荐）
```python
# app/core/error_codes.py
class ErrorCode:
    """业务错误码集中定义"""
    
    # 成功码（固定）
    SUCCESS = 20000
    
    # 系统错误 (50xxx)
    INTERNAL_ERROR = 50000
    DB_ERROR = 50001
    REDIS_ERROR = 50002
    
    # 用户域 (601xx)
    PHONE_EXISTS = 60101
    EMAIL_EXISTS = 60102
    USERNAME_EXISTS = 60103
    LOGIN_FAILED = 60201
    USER_NOT_FOUND = 60301
    
    # 商品域 (701xx)
    PRODUCT_NOT_FOUND = 70101
    STOCK_INSUFFICIENT = 70301
    
    # 订单域 (801xx)
    CART_LIMIT = 80102
    ORDER_NOT_FOUND = 80403
    
# 使用示例
from app.core.error_codes import ErrorCode

raise AppException(
    code=ErrorCode.STOCK_INSUFFICIENT, 
    message="库存不足"
)
```

**方式 B：枚举类型**（类型安全）
```python
from enum import IntEnum

class ErrorCode(IntEnum):
    SUCCESS = 20000
    PHONE_EXISTS = 60101
    STOCK_INSUFFICIENT = 70301
```

### 4. 前端处理示例
（连续累加版）
axios.interceptors.response.use(
  (response) => {
    const { code, message, data } = response.data;
    
    // 成功
    if (code === 20000) {
      return data;
    }
    
    // 业务错误细分处理（百位判断）
    const moduleCode = Math.floor(code / 100);
    
    switch (moduleCode) {
      case 601: // 60100-60199 用户注册
        Toast.error(message);
        break;
      
      case 602: // 60200-60299 用户登录
        Toast.error(message);
        router.push('/login');
        break;
      
      case 603: // 60300-60399 用户资料
        Toast.warning(message);
        break;
      
      case 607: // 60700-60799 库存管理
        Toast.warning(message);
        break;
      
      case 609: // 60900-60999 订单创建
      case 610: // 61000-61099 订单支付
        Toast.error(message);
        break;
      
      default:
        // 系统错误（50xxx）
        if (code >= 50000 && code < 60000) {
          Toast.error('系统异常，请稍后重试');
          router.push('/error');
        } else {
          // 其他业务错误
          Toast.error(message || '操作失败');
        }
    }
    
    // 默认处理
    Toast.error(message || '操作失败');
    return Promise.reject({ code, message });
  },
  (error) => {
    // HTTP 层错误（如 Network Error）
    Toast.error('网络异常，请稍后重试');
    return Promise.reject(error);
  }
);
```

### 5. 国际化（i18n）集成

**后端示例**：
```python
# 推荐使用 Flask-Babel 或 fastapi-babel 等库
from app.core.i18n import get_translation

_ = get_translation()

# ✅ 成功消息通过 i18n
return success(
    data=user,
    message=_("user.created")  # zh-CN: "用户创建成功" | en-US: "User created"
)
连续累加版：

### 旧码 → 新码映射
| 旧错误码 | 新错误码 | 说明 |
|---------|---------|------|
| 20000 | 20000 | ✅ 成功码保持不变 |
| 40001 | 60101 | 手机号已注册 |
| 40002 | 60102 | 邮箱已注册 |
| 40003 | 60103 | 用户名已占用 |
| 40100 | 60201 | 登录失败 |
| 30301 | 60701 | 库存不足（注意：从70301改为60701） |
| 40201 | 60901 | 订单金额错误 |
| 50000 | 50000 | ✅ 系统错误保持不变 |

### 迁移脚本示例
```python
# scripts/migrate_error_codes.py
ERROR_CODE_MAPPING = {
    40001: 60101,
    40002: 60102,
    40003: 60103,
    40100: 60201,
    30301: 60701,
    40201: 60901,
    # ... 其他映射
}

# 批量替换代码中的错误码
# (可使用 AST 工具或正则表达式)

---

## 📊 扩展示例

### 新增模块如何分配错误码？

**场景：新增"直播带货"模块**

1. **查看当前最大码位**：62099（消息通知模块）
2. **顺延分配**：62100-62199 分配给直播带货
3. **子模块细分**：
   - 62100-62109: 直播间管理
   - 62110-62119: 直播商品
   - 62120-62129: 互动功能

**代码定义**：
```python
# app/core/error_codes.py
class ErrorCode:
    # ... 已有错误码 ...
    
    # 直播带货模块 (62100-62199)
    LIVE_ROOM_NOT_FOUND = 62101
    LIVE_ROOM_OFFLINE = 62102
    LIVE_PRODUCT_SOLD_OUT = 62111
    LIVE_INTERACTION_LIMIT = 62121
```

**文档更新**：
```markdown
### 62100-62199: 直播带货
| Code  | Message | 说明 |
|-------|---------|------|
| 62101 | 直播间不存在 | 直播间 ID 无效 |
| 62102 | 直播间已下线 | 直播已结束 |
| 62111 | 直播商品已售罄 | 库存不足 |
| 62121 | 互动频率过快 | 防止刷屏 |
```
### 迁移脚本示例
```python
# scripts/migrate_error_codes.py
ERROR_CODE_MAPPING = {
    40001: 60101,
    40002: 60102,
    40003: 60103,
    # ... 其他映射
}

# 批量替换代码中的错误码
# (可使用 AST 工具或正则表达式)
